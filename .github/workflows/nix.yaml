name: nix:build
on:
  pull_request:
  push:
jobs:
  tests:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout ğŸ›ï¸
      uses: actions/checkout@v4

    - name: Install Nix â„
      uses: cachix/install-nix-action@v31

    - name: Cache Nix store ğŸ“¦
      uses: DeterminateSystems/magic-nix-cache-action@v8

    - name: Link Cachix ğŸ”Œ
      uses: cachix/cachix-action@v15
      with:
        name: kpbj-fm
        authToken: '${{ secrets.CACHIX_AUTH_TOKEN }}'
        pushFilter: '(-kpbj-api|-sync-host-emails|-token-cleanup|-lucid-|-web-server-core)'

    - name: Build ğŸ”¨
      run: nix build

    - name: Build NixOS closure for staging ğŸ—ï¸
      if: github.ref == 'refs/heads/main'
      run: nix build .#nixosConfigurations.kpbj-stream-staging.config.system.build.toplevel

    # - name: Check for dead code ğŸ§¹
    #   run: |
    #     nix develop --command cabal update
    #     nix develop --command cabal build all
    #     nix develop --command weeder
