# Base configuration for KPBJ streaming services
# Use with environment-specific overrides:
#   Local dev: docker compose -f docker-compose.yml -f docker-compose.dev.yml up -d
#   Staging:   docker compose -f docker-compose.yml -f docker-compose.staging.yml up -d
#   Production: docker compose -f docker-compose.yml -f docker-compose.prod.yml up -d

services:
  icecast:
    image: ghcr.io/solomon-b/kpbj-icecast:${IMAGE_TAG:-latest}
    # Ports defined in environment-specific overrides (dev: 8000, staging: 8001, prod: 8000)
    # Config is bundled in image; env vars applied at startup by entrypoint
    healthcheck:
      test: ["CMD", "curl", "-sf", "http://localhost:8000/status-json.xsl"]
      interval: 5s
      timeout: 3s
      retries: 3
    environment:
      - ICECAST_SOURCE_PASSWORD=${ICECAST_SOURCE_PASSWORD:-hackme}
      - ICECAST_ADMIN_PASSWORD=${ICECAST_ADMIN_PASSWORD:-hackme}
      - ICECAST_RELAY_PASSWORD=${ICECAST_RELAY_PASSWORD:-hackme}
    restart: unless-stopped

  liquidsoap:
    image: ghcr.io/solomon-b/kpbj-liquidsoap:${IMAGE_TAG:-latest}
    depends_on:
      icecast:
        condition: service_healthy
    # Config (radio.liq) is bundled in image
    environment:
      - ICECAST_HOST=icecast
      - ICECAST_PORT=8000
      - ICECAST_PASSWORD=${ICECAST_SOURCE_PASSWORD:-hackme}
      - ICECAST_MOUNT=/stream
    restart: unless-stopped

  webhook:
    image: ghcr.io/solomon-b/kpbj-webhook:${IMAGE_TAG:-latest}
    volumes:
      - /var/run/docker.sock:/var/run/docker.sock
      - ./hooks.yaml:/config/hooks.yaml:ro
    environment:
      - WEBHOOK_SECRET=${WEBHOOK_SECRET:-}
      - RESTART_CMD=/bin/docker
    restart: unless-stopped
