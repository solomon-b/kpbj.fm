# Provisioning & Deployment Guide

Complete instructions for provisioning the KPBJ streaming infrastructure from scratch. This covers Terraform, NixOS droplets, sops-nix secrets, and Fly.io sync.

## Current State

- Production stream (`stream.kpbj.fm`) runs on an existing Ubuntu VPS at `167.172.122.186`
- Cloudflare DNS records already exist (need to be imported into Terraform state)
- DigitalOcean droplets do not exist yet (Terraform creates them fresh)
- Staging will cut over to the new NixOS droplet immediately
- Production stays on the legacy VPS until manual cutover

## Prerequisites

Enter the dev shell and ensure these env vars are set (in `.envrc.local`):

```bash
# Tigris S3 (Terraform remote state backend)
export TERRAFORM_ACCESS_KEY_ID="..."
export TERRAFORM_SECRET_ACCESS_KEY="..."

# SOPS age key
export SOPS_AGE_KEY_FILE="$HOME/.config/sops/age/keys.txt"
```

Tools provided by `nix develop`: `terraform`, `sops`, `age`, `ssh-to-age`, `just`, `jq`.

---

## Phase 1: Terraform Init & Import Cloudflare

```bash
# Initialize Terraform with remote state backend
just tf-init

# Generate Cloudflare import blocks (discovers existing DNS record IDs via API)
./scripts/tf-import.sh

# Review the plan
just tf-plan
```

The plan should show:
- ~25 Cloudflare DNS records being **imported** (no changes, except `stream.staging.kpbj.fm` content will change to the new droplet IP)
- `stream.kpbj.fm` imported with **no change** (hardcoded to `167.172.122.186`)
- 2 DigitalOcean droplets being **created** (prod + staging)
- 2 DigitalOcean firewalls being **created**
- 3 DigitalOcean SSH keys being **created**

## Phase 2: Apply Terraform

```bash
just tf-apply
```

Note the droplet IPs from the output:

```
stream_prod_droplet_ip = "x.x.x.x"
stream_staging_droplet_ip = "y.y.y.y"
```

Clean up the one-time import file:

```bash
rm terraform/imports.tf
```

At this point:
- Droplets are booting Ubuntu. The `user_data` script in the Terraform config automatically runs `nixos-infect`, which converts the droplet from Ubuntu to NixOS and reboots. This takes ~5-10 minutes. You don't need to do anything — just wait.
- `stream.kpbj.fm` still points to the legacy VPS (no downtime)
- `stream.staging.kpbj.fm` now points to the new staging droplet

## Phase 3: NixOS Setup (get host age keys)

`nixos-setup` **does not** run nixos-infect — that already happened automatically in Phase 2. Instead, it:

1. Polls SSH until it detects NixOS is running (waits up to 10 minutes)
2. Copies `hardware-configuration.nix` from the droplet
3. Copies `networking.nix` from the droplet (static IP config generated by nixos-infect)
4. Retrieves the host's age public key for SOPS encryption

Run these one at a time:

```bash
just nixos-setup root@<staging-ip> staging
```

**Important:** Use the droplet IP directly, not the hostname. DNS may not have propagated yet.

Output will include:

```
   Host age key: age1abc123...
   Add this key to .sops.yaml under &vps_stream_staging
```

Save the key. Then do the same for prod:

```bash
just nixos-setup root@<prod-ip> prod
```

Save that key too.

**Stage the networking files** (the flake requires them to be git-tracked):

```bash
git add nixos/networking-staging.nix nixos/networking-prod.nix
```

**Note:** Each environment gets its own networking file (`networking-staging.nix`, `networking-prod.nix`) with the droplet's static IP config. These files are overwritten by `nixos-setup` whenever you provision a new droplet. The hardware config (`hardware-digitalocean.nix`) is shared since both droplets use the same DigitalOcean hardware.

## Phase 4: Configure SOPS Keys

Edit `.sops.yaml` and replace the placeholder keys with the real ones from Phase 3:

```yaml
- &vps_stream_prod age1<REPLACE_WITH_REAL_PROD_KEY>
- &vps_stream_staging age1<REPLACE_WITH_REAL_STAGING_KEY>
```

## Phase 5: Create Streaming Secrets

Generate random values for each secret. Helper command:

```bash
head /dev/urandom | tr -dc a-zA-Z0-9 | head -c 32; echo
```

### Staging

```bash
sops secrets/staging-streaming.yaml
```

Your `$EDITOR` opens. Enter:

```yaml
icecast_admin_password: <random-32>
icecast_relay_password: <random-32>
icecast_password: <random-32>
webhook_secret: <random-32>
playout_secret: <random-32>
```

**Note:** `icecast_password` is the source password shared between Icecast and Liquidsoap.

Save and close. SOPS encrypts the file automatically.

### Production

```bash
sops secrets/prod-streaming.yaml
```

Same format, different random values.

## Phase 6: Build & Push Container Images

The NixOS config references container images from GHCR. Make sure they're built and pushed:

```bash
just stream-publish
```

This triggers the GitHub Actions workflow. Monitor with `gh run watch`.

Alternatively, if you need to push manually:

```bash
just stream-dev-build  # Build locally
# Then push via docker push
```

## Phase 7: Deploy Staging

```bash
just nixos-deploy-staging
```

This runs `nixos-rebuild boot` targeting the staging droplet and then reboots. sops-nix will decrypt `secrets/staging-streaming.yaml` using the host's SSH key and render the env file for the containers.

### Verify staging

```bash
# Check container status
ssh root@stream.staging.kpbj.fm systemctl status podman-kpbj-liquidsoap
ssh root@stream.staging.kpbj.fm systemctl status podman-kpbj-icecast

# Check the rendered secrets file exists
ssh root@stream.staging.kpbj.fm ls -la /run/secrets/rendered/kpbj-stream.env

# Test the stream endpoint
curl -I https://stream.staging.kpbj.fm/stream

# Check nginx
ssh root@stream.staging.kpbj.fm systemctl status nginx
```

### Sync staging secrets to Fly.io

```bash
just fly-sync-secrets-staging

# Verify
fly secrets list --app kpbj-fm-staging
```

The staging web service will restart with the new `PLAYOUT_SECRET` and `WEBHOOK_SECRET`. Verify that the playout API works end-to-end (Liquidsoap should be polling and streaming).

## Phase 8: Deploy Production

Once staging is verified:

```bash
# Use IP directly — stream.kpbj.fm still points to legacy VPS
nixos-rebuild boot --flake .#kpbj-stream-prod --target-host root@<prod-droplet-ip>
ssh root@<prod-droplet-ip> reboot
```

**Note:** `just nixos-deploy-prod` targets `stream.kpbj.fm` which still points to the legacy VPS at this point. Use the droplet IP directly until DNS cutover is complete.

### Verify production (on the new droplet, before DNS cutover)

The prod NixOS droplet is now running but `stream.kpbj.fm` still points to the legacy VPS. You can test the new droplet directly by IP:

```bash
curl -I http://<prod-droplet-ip>:8000/stream
```

Note: HTTPS won't work until DNS points here (ACME needs the domain to resolve to the droplet for certificate issuance).

### Sync production secrets to Fly.io

```bash
just fly-sync-secrets-prod

# Verify
fly secrets list --app kpbj-fm
```

**Important:** After syncing, the Fly.io web service will restart with the new `PLAYOUT_SECRET`. This means the legacy VPS's Liquidsoap (which has the old secret) will start getting 401s from the playout API. You have two options:

1. **Cut over DNS immediately after syncing** (go to Phase 9)
2. **Temporarily set the old PLAYOUT_SECRET on Fly.io** until you're ready to cut over, then sync again when you switch DNS

## Phase 9: Production DNS Cutover

When you're confident the new NixOS prod droplet is working:

Edit `terraform/cloudflare.tf` and change the prod stream record from the hardcoded IP back to the droplet reference:

```hcl
resource "cloudflare_dns_record" "stream" {
  zone_id = local.cloudflare_zone_id
  name    = "stream"
  type    = "A"
  content = digitalocean_droplet.stream_prod.ipv4_address  # ← change this line
  proxied = false
  ttl     = 1
  comment = "Production audio stream (DO)"  # ← update comment too
}
```

Remove the TODO comment above it.

```bash
just tf-plan   # Should show only the stream record content changing
just tf-apply  # DNS cutover happens here
```

DNS propagation is fast (TTL=1, Cloudflare). After a minute or two:

```bash
curl -I https://stream.kpbj.fm/stream
```

ACME certificate issuance will happen automatically via NixOS nginx. It may take a few minutes for the first cert.

## Phase 10: Cleanup

Once everything is stable on the new droplets:

1. Decommission the legacy Ubuntu VPS
2. Commit all changes (`.sops.yaml` with real keys, `secrets/*.yaml` encrypted files, `cloudflare.tf` with droplet reference)

---

## Troubleshooting

### nixos-infect hasn't finished

Check the droplet console in DigitalOcean, or SSH in and check `/tmp/nixos-infect.log`.

### sops-nix can't decrypt secrets

The host needs an ed25519 SSH key and the corresponding age public key must be in `.sops.yaml`. Verify:

```bash
# Get the host's age key
just sops-host-key <hostname>

# Compare with what's in .sops.yaml
```

If keys don't match (e.g., after a droplet rebuild), update `.sops.yaml` and re-encrypt:

```bash
sops updatekeys secrets/prod-streaming.yaml
sops updatekeys secrets/staging-streaming.yaml
```

### Containers aren't starting

```bash
ssh root@<ip> journalctl -u podman-kpbj-icecast --no-pager -n 50
ssh root@<ip> journalctl -u podman-kpbj-liquidsoap --no-pager -n 50
ssh root@<ip> journalctl -u podman-kpbj-webhook --no-pager -n 50
```

### ACME certificate not issuing

```bash
ssh root@<ip> journalctl -u acme-stream.kpbj.fm --no-pager -n 50
```

ACME requires DNS to resolve to the droplet. If you're testing before DNS cutover, certs won't issue.

### Liquidsoap getting 401 from Icecast

The `ICECAST_PASSWORD` values don't match between containers, or Icecast is running a cached image. Force pull and restart:

```bash
ssh root@<ip> "podman pull ghcr.io/solomon-b/kpbj-icecast:latest && systemctl restart podman-kpbj-icecast && sleep 5 && systemctl restart podman-kpbj-liquidsoap"
```

### Liquidsoap getting 401 from playout API

The `PLAYOUT_SECRET` on the VPS doesn't match what Fly.io expects. Re-sync:

```bash
just fly-sync-secrets-prod   # or staging
```

### Container running old image after deploy

Podman caches `:latest` tags. Force pull the new image:

```bash
ssh root@<ip> "podman pull ghcr.io/solomon-b/kpbj-liquidsoap:latest && systemctl restart podman-kpbj-liquidsoap"
```

---

## Day-to-Day Reference

| Task | Command |
|------|---------|
| Edit streaming secrets | `just sops-edit-prod-streaming` / `just sops-edit-staging-streaming` |
| Edit Terraform secrets | `just tf-edit-secrets` |
| Deploy NixOS config | `just nixos-deploy-prod` / `just nixos-deploy-staging` |
| Sync secrets to Fly.io | `just fly-sync-secrets-prod` / `just fly-sync-secrets-staging` |
| Get a host's age key | `just sops-host-key <hostname>` |
| Preview infra changes | `just tf-plan` |
| Apply infra changes | `just tf-apply` |
| Build/push stream images | `just stream-publish` |
