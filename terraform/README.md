# KPBJ Terraform Infrastructure

Terraform configuration for KPBJ 95.9FM infrastructure: DigitalOcean streaming VPS and Cloudflare DNS + proxy.

## Prerequisites

- [Terraform](https://developer.hashicorp.com/terraform/install) >= 1.5
- [just](https://github.com/casey/just) — task runner
- [sops](https://github.com/getsops/sops) + [age](https://github.com/FiloSottile/age) — secrets management
- [jq](https://jqlang.github.io/jq/) — JSON processing (for import script)

## Setup

```bash
# 1. Initialize providers (passes S3 backend credentials automatically)
just tf-init

# 2. Import existing Cloudflare resources (see below)

# 3. Verify state matches reality
just tf-plan
```

The S3 backend requires `-backend-config` credentials for Tigris. `just tf-init` handles this using `TERRAFORM_ACCESS_KEY_ID` and `TERRAFORM_SECRET_ACCESS_KEY` from your environment.

**State locking is not available.** Tigris S3 does not support DynamoDB-style lock tables, so concurrent `terraform apply` runs can corrupt state. Only one person should run plan/apply at a time.

## Importing Existing Resources

Since Cloudflare DNS records already exist, run the import script to bring them into Terraform state:

```bash
# 1. Generate declarative import blocks
./scripts/tf-import.sh

# 2. Review the generated file
cat terraform/imports.tf

# 3. Plan — should show imports with no other changes
just tf-plan

# 4. Apply — imports resources into state
just tf-apply

# 5. Clean up the ephemeral file
rm terraform/imports.tf
```

DigitalOcean resources (droplets, firewalls, SSH keys) are provisioned fresh by Terraform — they are not imported.

## Secrets

Sensitive values (API tokens, zone IDs) are stored in `secrets/terraform.yaml`, encrypted with SOPS + age.

```bash
# Edit secrets (opens in $EDITOR, re-encrypts on save)
just tf-edit-secrets
```

## Day-to-Day Usage

```bash
# Preview changes
just tf-plan

# Apply changes
just tf-apply

# Show current state
just tf-show

# Format files
just tf-fmt

# Validate configuration
just tf-validate
```

## What Terraform Manages

| Resource                             | Provider     | File              |
|--------------------------------------|--------------|-------------------|
| DigitalOcean droplets (prod + staging) | digitalocean | `digitalocean.tf` |
| DigitalOcean firewalls (prod + staging) | digitalocean | `digitalocean.tf` |
| DigitalOcean SSH keys                | digitalocean | `digitalocean.tf` |
| Cloudflare DNS records               | cloudflare   | `cloudflare.tf`   |
| Cloudflare proxy settings            | cloudflare   | `cloudflare.tf`   |
| GCP Admin SDK API enablement         | google       | `google.tf`       |
| GCP service account + key            | google       | `google.tf`       |

## What Stays Manual

- **Fly.io web service** — managed via `flyctl` + CI/CD
- **GitHub Actions CI/CD** — workflows in `.github/workflows/`
- **NixOS streaming VPS configuration** — deployed via `just nixos-deploy-*`
- **Streaming secrets** — SOPS-encrypted in `secrets/`, decrypted by sops-nix on VPS
- **fly.toml** — used by CI production deploy workflow
- **GHCR image builds** — handled by GitHub Actions

## File Overview

| File                       | Purpose                                                       |
|----------------------------|---------------------------------------------------------------|
| `main.tf`                  | Terraform block, providers, S3 backend                        |
| `variables.tf`             | All input variables                                           |
| `cloudflare.tf`            | Cloudflare DNS records and proxy settings                     |
| `digitalocean.tf`          | DigitalOcean droplet, firewall, SSH keys                      |
| `secrets.tf`               | SOPS-encrypted secret variable declarations                   |
| `../secrets/terraform.yaml` | SOPS-encrypted secret values (in repo-root `secrets/`)       |
| `google.tf`                | GCP service account for Google Groups API                     |
| `outputs.tf`               | Useful output values                                          |
| `imports.tf`               | Generated by `tf-import.sh`, deleted after apply (gitignored) |
